<launch>

  <arg name="ouster_ns" default="ouster" description="Override the default namespace of all ouster nodes"/>
  <arg name="timestamp_mode" default="" description="method used to timestamp measurements; possible values: {
    TIME_FROM_INTERNAL_OSC,
    TIME_FROM_SYNC_PULSE_IN,
    TIME_FROM_PTP_1588,
    TIME_FROM_ROS_TIME
    }"/>
  <arg name="metadata" description="path to write metadata file when receiving sensor data"/>
  <arg name="bag_file" description="file name to use for the recorded bag file"/>
  <arg name="viz" default="true" description="whether to run a rviz"/>
  <arg name="rviz_config" default="$(find-pkg-share ouster_ros)/config/viz.rviz" description="optional rviz config file"/>
  <arg name="tf_prefix" default="" description="namespace for tf transforms"/>

  <group>
    <push-ros-namespace namespace="$(var ouster_ns)"/>
    <node_container pkg="rclcpp_components" exec="component_container_mt" name="os_container" output="screen" namespace="">
      <composable_node pkg="ouster_ros" plugin="ouster_ros::OusterReplay" name="os_replay">
        <param name="metadata" value="$(var metadata)"/>
      </composable_node>
      <composable_node pkg="ouster_ros" plugin="ouster_ros::OusterCloud" name="os_cloud">
        <param name="tf_prefix" value="$(var tf_prefix)"/>
        <param name="timestamp_mode" value="$(var timestamp_mode)"/>
      </composable_node>
      <composable_node pkg="ouster_ros" plugin="ouster_ros::OusterImage" name="os_image"/>
    </node_container>
  </group>

  <group if="$(var viz)">
    <push-ros-namespace namespace="$(var ouster_ns)"/>
    <!-- NOTE: this is rather a workaround to let rviz2 get going and not complain while waiting
      for the actual sensor frames to be published that is when when using the same launch file
      to run rviz2 -->
    <node pkg="tf2_ros" exec="static_transform_publisher" name="stp_sensor_imu"
      args="0 0 0 0 0 0 os_sensor os_imu"/>
    <node pkg="tf2_ros" exec="static_transform_publisher" name="stp_sensor_lidar"
      args="0 0 0 0 0 0 os_sensor os_lidar"/>
    <node pkg="rviz2" exec="rviz2" name="rviz2" output="screen"
      launch-prefix="bash -c 'sleep 5; $0 $@'" args="-d $(var rviz_config)"/>
  </group>

  <let name="_use_bag_file_name" value="$(eval '\'$(var bag_file)\' != \'b\'')"/>

  <executable if="$(var _use_bag_file_name)" output="screen"
    launch-prefix="bash -c 'sleep 3; $0 $@'"
    cmd="ros2 bag play $(var bag_file) --clock"/>

</launch>
